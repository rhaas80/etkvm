#!/bin/bash
set -e
RELEASE=$1
if [ ! -f install_$RELEASE ] ; then
  echo "You need to specify a release and the file install_\$RELEASE needs to be present.";
  exit 1
fi

DIST=wheezy
URL=http://cdimage.debian.org/mirror/cdimage/archive/7.8.0/amd64/iso-cd/debian-7.8.0-amd64-netinst.iso
#DIST=jessie
#URL=http://cdimage.debian.org/debian-cd/8.0.0/amd64/iso-cd/debian-8.0.0-amd64-netinst.iso

CD_DST=${DIST}_$RELEASE
rm -rf $CD_DST
mkdir $CD_DST
wget -cN $URL
bsdtar -C $CD_DST -xf `basename $URL`
chmod -R +w $CD_DST
cd $CD_DST
perl -pi -e 's/initrd\.gz/initrd\.gz auto-install\/enable=true preseed\/file=\/cdrom\/preseed.cfg/'  isolinux/txt.cfg
perl -pi -e 's/timeout 0/timeout 1/' isolinux/isolinux.cfg
cp ../preseed.cfg ../postseed .
mkdir et_misc
cp ../install_$RELEASE et_misc/
md5sum `find ! -name "md5sum.txt" ! -path "./isolinux/*" -follow -type f` > md5sum.txt
cd ..
genisoimage -o ${DIST}_$RELEASE.iso -r -J -no-emul-boot -boot-load-size 4 -boot-info-table -b isolinux/isolinux.bin -c isolinux/boot.cat $CD_DST
rm -rf $CD_DST

VMNAME=${DIST}_$RELEASE

VBoxManage createvm --name $VMNAME --register

# standard settings
VBoxManage modifyvm      $VMNAME --ostype Debian_64 --acpi on --biosbootmenu disabled --rtcuseutc on

### minimal system
VBoxManage modifyvm      $VMNAME --memory 1024 --cpus 1

### workstation class
#VBoxManage modifyvm      $VMNAME --memory 4096 --cpus 8 --ioapic on --vram 64 --usb on

# rest of standard settings
VBoxManage storagectl    $VMNAME --name "IDE Controller" --add ide --controller PIIX4
VBoxManage storagectl    $VMNAME --name "SATA Controller" --add sata --controller IntelAhci
VBoxManage storageattach $VMNAME --storagectl "IDE Controller" --port 0 --device 0 --type dvddrive --medium `pwd`/$VMNAME.iso
VBoxManage createhd --filename $VMNAME.vdi --size 32768
VBoxManage storageattach $VMNAME --storagectl "SATA Controller" --port 0 --device 0 --type hdd --medium $VMNAME.vdi
VBoxManage modifyvm      $VMNAME --nic1 nat --nictype1 82540EM 
VBoxManage modifyvm      $VMNAME --natpf1 "ssh,tcp,,2222,,22"
VBoxManage modifyvm      $VMNAME --audio alsa
VBoxManage startvm       $VMNAME
